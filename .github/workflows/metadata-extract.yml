name: Metadata Extract

on:
  workflow_call:
    outputs:
      tags:
        description: 'Newline-separated list of Docker image tag names (registry-agnostic)'
        value: ${{ jobs.extract-metadata.outputs.tags }}

permissions:
  contents: read

jobs:
  extract-metadata:
    name: Extract Build Metadata
    runs-on: ubuntu-latest
    outputs:
      tags: ${{ steps.extract.outputs.tags }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Extract metadata
        id: extract
        run: |
          set -euo pipefail

          # Determine tags based on context (deployment uses digest, not tags)
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # PR build - use pr-{number}-{sha} (unique per commit, clearly indicates origin)
            # Use PR head SHA (actual commit) instead of merge commit for traceability
            SHA_SHORT=$(echo "${{ github.event.pull_request.head.sha }}" | cut -c1-7)
            TAGS="pr-${{ github.event.pull_request.number }}-${SHA_SHORT}"
          else
            # Main branch or manual - build multiple tags (SHA, latest, version if available)
            SHA_SHORT=$(git rev-parse --short HEAD)
            TAGS="${SHA_SHORT}"$'\n'"latest"
            # Add semantic version tag if available
            if VERSION=$(git describe --tags --exact-match 2>/dev/null); then
              TAGS="${TAGS}"$'\n'"${VERSION}"
            fi
          fi

          echo "tags<<EOF" >> $GITHUB_OUTPUT
          echo "$TAGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate Job Summary
        run: |
          set -euo pipefail

          # Use PR head SHA for pull requests, git SHA for other events
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            SHA_SHORT=$(echo "${{ github.event.pull_request.head.sha }}" | cut -c1-7)
          else
            SHA_SHORT=$(git rev-parse --short HEAD)
          fi

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ“¦ Build Metadata

          | Event | Branch | Commit |
          |-------|--------|--------|
          | \`${{ github.event_name }}\` | \`${{ github.head_ref || github.ref_name }}\` | \`${SHA_SHORT}\` |

          ### ðŸ·ï¸ Image Tags
          EOF

          # Format tags as bulleted list (tags already newline-separated)
          echo "${{ steps.extract.outputs.tags }}" | grep -v '^$' | while read -r tag; do
            echo "- \`${tag}\`" >> $GITHUB_STEP_SUMMARY
          done

          # Add separator
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
