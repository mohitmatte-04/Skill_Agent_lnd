name: Terraform Plan and Apply

on:
  workflow_call:
    inputs:
      docker_image:
        description: 'Docker image URI to deploy'
        required: true
        type: string
      workspace:
        description: 'Terraform workspace'
        required: false
        type: string
        default: 'default'
      terraform_action:
        description: 'Terraform action (plan or apply)'
        required: false
        type: string
        default: 'plan'

permissions:
  contents: read
  id-token: write
  pull-requests: write  # For PR comments

concurrency:
  group: terraform-deploy-${{ inputs.workspace }}
  cancel-in-progress: false

jobs:
  terraform:
    name: Terraform ${{ inputs.terraform_action }}
    runs-on: ubuntu-latest

    env:
      # Required Terraform variables
      TF_VAR_project: ${{ vars.GCP_PROJECT_ID }}
      TF_VAR_location: ${{ vars.GCP_LOCATION }}
      TF_VAR_agent_name: ${{ vars.IMAGE_NAME }}
      TF_VAR_terraform_state_bucket: ${{ vars.TERRAFORM_STATE_BUCKET }}
      TF_VAR_docker_image: ${{ inputs.docker_image }}

      # Optional Terraform variables (Github Actions will default to empty strings if not set)
      TF_VAR_adk_suppress_experimental_feature_warnings: ${{ vars.ADK_SUPPRESS_EXPERIMENTAL_FEATURE_WARNINGS }}
      TF_VAR_agent_engine: ${{ vars.AGENT_ENGINE }}
      TF_VAR_allow_origins: ${{ vars.ALLOW_ORIGINS }}
      TF_VAR_artifact_service_uri: ${{ vars.ARTIFACT_SERVICE_URI }}
      TF_VAR_log_level: ${{ vars.LOG_LEVEL }}
      TF_VAR_root_agent_model: ${{ vars.ROOT_AGENT_MODEL }}
      TF_VAR_serve_web_interface: ${{ vars.SERVE_WEB_INTERFACE }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~> 1.14.0"
          terraform_wrapper: false  # Better output handling

      - name: Terraform Format Check
        id: fmt
        working-directory: terraform/main
        run: terraform fmt -check -recursive

      - name: Terraform Init
        id: init
        working-directory: terraform/main
        run: |
          terraform init \
            -backend-config="bucket=${{ vars.TERRAFORM_STATE_BUCKET }}"

      - name: Terraform Validate
        id: validate
        working-directory: terraform/main
        run: |
          OUTPUT=$(terraform validate -no-color 2>&1)
          echo "stdout<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Terraform Plan
        id: plan
        working-directory: terraform/main
        run: |
          terraform workspace select --or-create ${{ inputs.workspace }}
          OUTPUT=$(terraform plan -no-color -input=false -out=tfplan 2>&1)
          echo "stdout<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Comment PR with Plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Extract step results
            const results = {
              fmt: '${{ steps.fmt.outcome }}',
              init: '${{ steps.init.outcome }}',
              validate: '${{ steps.validate.outcome }}',
              plan: '${{ steps.plan.outcome }}',
              validateOutput: `${{ steps.validate.outputs.stdout }}` || 'No output',
              planOutput: `${{ steps.plan.outputs.stdout }}` || 'No plan available'
            };

            // Map outcomes to icons
            const statusIcon = (outcome) => {
              const icons = {
                success: 'âœ…',
                failure: 'âŒ',
                skipped: 'â­ï¸',
                cancelled: 'ğŸš«',
                timed_out: 'â±ï¸'
              };
              return icons[outcome] || 'â“';
            };

            // Build comment body
            const body = `
            ## Terraform Plan Summary

            | Step | Status |
            |------|:------:|
            | ğŸ–Œ Format & Style | ${statusIcon(results.fmt)} \`${results.fmt}\` |
            | âš™ï¸ Initialization | ${statusIcon(results.init)} \`${results.init}\` |
            | ğŸ¤– Validation | ${statusIcon(results.validate)} \`${results.validate}\` |
            | ğŸ“– Plan | ${statusIcon(results.plan)} \`${results.plan}\` |

            <details><summary>Validation Output</summary>

            \`\`\`
            ${results.validateOutput}
            \`\`\`

            </details>

            <details><summary>Plan Output</summary>

            \`\`\`terraform
            ${results.planOutput}
            \`\`\`

            </details>

            ---
            *Pushed by @${{ github.actor }} Â· ${{ github.event_name }}*
            `.trim();

            // Post comment
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Terraform Plan Status
        if: steps.plan.outcome == 'failure'
        run: exit 1

      - name: Terraform Apply
        if: inputs.terraform_action == 'apply'
        working-directory: terraform/main
        run: |
          terraform workspace select ${{ inputs.workspace }}
          terraform apply -auto-approve -input=false tfplan

      - name: Output Service URL
        if: inputs.terraform_action == 'apply'
        working-directory: terraform/main
        run: |
          echo "ğŸ‰ Deployment successful!"
          echo ""
          echo "ğŸ“ Cloud Run Services:"
          terraform output -json cloud_run_services | jq -r 'to_entries[] | "  \(.key): \(.value.uri)"'
