name: Terraform Plan and Apply

on:
  workflow_call:
    inputs:
      docker_image:
        description: 'Docker image URI to deploy'
        required: true
        type: string
      workspace:
        description: 'Terraform workspace'
        required: false
        type: string
        default: 'default'
      terraform_action:
        description: 'Terraform action (plan or apply)'
        required: false
        type: string
        default: 'plan'

permissions:
  contents: read
  id-token: write
  pull-requests: write  # For PR comments

concurrency:
  group: terraform-deploy-${{ inputs.workspace }}
  cancel-in-progress: false

jobs:
  terraform:
    name: Terraform ${{ inputs.terraform_action }}
    runs-on: ubuntu-latest

    env:
      # Required Terraform variables
      TF_VAR_project: ${{ vars.GCP_PROJECT_ID }}
      TF_VAR_location: ${{ vars.GCP_LOCATION }}
      TF_VAR_agent_name: ${{ vars.IMAGE_NAME }}
      TF_VAR_otel_instrumentation_genai_capture_message_content: ${{ vars.OTEL_INSTRUMENTATION_GENAI_CAPTURE_MESSAGE_CONTENT }}
      TF_VAR_terraform_state_bucket: ${{ vars.TERRAFORM_STATE_BUCKET }}
      TF_VAR_docker_image: ${{ inputs.docker_image }}

      # Optional Terraform variables (Github Actions will default to empty strings if not set)
      TF_VAR_adk_suppress_experimental_feature_warnings: ${{ vars.ADK_SUPPRESS_EXPERIMENTAL_FEATURE_WARNINGS }}
      TF_VAR_agent_engine: ${{ vars.AGENT_ENGINE }}
      TF_VAR_allow_origins: ${{ vars.ALLOW_ORIGINS }}
      TF_VAR_artifact_service_uri: ${{ vars.ARTIFACT_SERVICE_URI }}
      TF_VAR_log_level: ${{ vars.LOG_LEVEL }}
      TF_VAR_root_agent_model: ${{ vars.ROOT_AGENT_MODEL }}
      TF_VAR_serve_web_interface: ${{ vars.SERVE_WEB_INTERFACE }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          project_id: ${{ vars.GCP_PROJECT_ID }}
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~> 1.14.0"
          terraform_wrapper: false  # Better output handling

      - name: Terraform Format Check
        id: fmt
        working-directory: terraform/main
        run: terraform fmt -check -recursive

      - name: Terraform Init
        id: init
        working-directory: terraform/main
        run: |
          terraform init \
            -backend-config="bucket=${{ vars.TERRAFORM_STATE_BUCKET }}"

      - name: Terraform Validate
        id: validate
        working-directory: terraform/main
        run: |
          OUTPUT=$(terraform validate -no-color 2>&1)
          echo "stdout<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Terraform Plan
        id: plan
        working-directory: terraform/main
        shell: bash {0}  # Removes -e flag to allow capturing output on failure
        run: |
          terraform workspace select --or-create ${{ inputs.workspace }}
          WORKSPACE=$(terraform workspace show)
          echo "Selected Terraform workspace: $WORKSPACE"

          # Create secure temp file
          PLAN_OUTPUT_FILE=$(mktemp)

          # Stream output to both logs (real-time) and file (for summary)
          terraform plan -no-color -input=false -out=tfplan 2>&1 | tee "$PLAN_OUTPUT_FILE"
          EXIT_CODE=${PIPESTATUS[0]}  # Get exit code from terraform, not tee

          # Read captured output for summary
          OUTPUT=$(cat "$PLAN_OUTPUT_FILE")

          # Save for summary
          echo "stdout<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "exitcode=$EXIT_CODE" >> $GITHUB_OUTPUT
          echo "workspace=$WORKSPACE" >> $GITHUB_OUTPUT

          # Clean up temp file
          rm -f "$PLAN_OUTPUT_FILE"

          exit $EXIT_CODE
        continue-on-error: true

      - name: Generate Plan Summary
        if: always()
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Map step outcomes to status icons
            const statusIcon = (outcome) => ({
              success: 'âœ…',
              failure: 'âŒ',
              skipped: 'â­ï¸',
              cancelled: 'ğŸš«',
              timed_out: 'â±ï¸'
            }[outcome] || 'â“');

            // Build plan summary
            const body = `
            ## ğŸ—ï¸ Terraform Plan Summary

            **ğŸŒ Terraform Workspace:** \`${{ steps.plan.outputs.workspace }}\`

            | Step | Status |
            |------|:------:|
            | ğŸ–Œ Format & Style | ${statusIcon('${{ steps.fmt.outcome }}')} \`${{ steps.fmt.outcome }}\` |
            | âš™ï¸ Initialization | ${statusIcon('${{ steps.init.outcome }}')} \`${{ steps.init.outcome }}\` |
            | ğŸ¤– Validation | ${statusIcon('${{ steps.validate.outcome }}')} \`${{ steps.validate.outcome }}\` |
            | ğŸ“– Plan | ${statusIcon('${{ steps.plan.outcome }}')} \`${{ steps.plan.outcome }}\` |

            <details><summary>Validation Output</summary>

            \`\`\`
            ${{ steps.validate.outputs.stdout || 'No output' }}
            \`\`\`

            </details>

            <details><summary>Plan Output</summary>

            \`\`\`terraform
            ${{ steps.plan.outputs.stdout || 'No plan available' }}
            \`\`\`

            </details>

            ---
            `.trim();

            // Always write to job summary
            fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, body + '\n');

            // Additionally post PR comment if this is a PR
            if (context.eventName === 'pull_request') {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body
              });
            }

      - name: Terraform Plan Status
        if: steps.plan.outputs.exitcode != '0' && steps.plan.outputs.exitcode != ''
        run: |
          echo "::error::Terraform plan failed with exit code ${{ steps.plan.outputs.exitcode }}"
          exit 1

      - name: Terraform Apply
        id: apply
        if: inputs.terraform_action == 'apply'
        working-directory: terraform/main
        shell: bash {0}  # Removes -e flag to allow capturing output on failure
        run: |
          terraform workspace select ${{ inputs.workspace }}
          WORKSPACE=$(terraform workspace show)
          echo "Selected Terraform workspace: $WORKSPACE"

          # Create secure temp file
          APPLY_OUTPUT_FILE=$(mktemp)

          # Stream output to both logs (real-time) and file (for summary)
          terraform apply -auto-approve -input=false -no-color tfplan 2>&1 | tee "$APPLY_OUTPUT_FILE"
          EXIT_CODE=${PIPESTATUS[0]}  # Get exit code from terraform, not tee

          # Read captured output for summary
          OUTPUT=$(cat "$APPLY_OUTPUT_FILE")

          # Save for summary
          echo "stdout<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "exitcode=$EXIT_CODE" >> $GITHUB_OUTPUT
          echo "workspace=$WORKSPACE" >> $GITHUB_OUTPUT

          # Clean up temp file
          rm -f "$APPLY_OUTPUT_FILE"

          exit $EXIT_CODE
        continue-on-error: true

      - name: Generate Apply Summary
        if: always() && steps.apply.outcome != 'skipped'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Map step outcomes to status icons
            const statusIcon = (outcome) => ({
              success: 'âœ…',
              failure: 'âŒ',
              skipped: 'â­ï¸',
              cancelled: 'ğŸš«',
              timed_out: 'â±ï¸'
            }[outcome] || 'â“');

            // Build apply summary
            const body = `
            ## ğŸš€ Terraform Apply Summary

            **ğŸŒ Terraform Workspace:** \`${{ steps.apply.outputs.workspace }}\`

            | Step | Status |
            |------|:------:|
            | ğŸš€ Apply | ${statusIcon('${{ steps.apply.outcome }}')} \`${{ steps.apply.outcome }}\` |

            <details><summary>Apply Output</summary>

            \`\`\`terraform
            ${{ steps.apply.outputs.stdout || 'No output' }}
            \`\`\`

            </details>

            ---
            `.trim();

            // Write to job summary
            fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, body + '\n');

      - name: Terraform Apply Status
        if: steps.apply.outputs.exitcode != '0' && steps.apply.outputs.exitcode != ''
        run: |
          echo "::error::Terraform apply failed with exit code ${{ steps.apply.outputs.exitcode }}"
          exit 1
